# UNDER CONSTRUCTION

## 何をするものか
Chess.comに公開されている情報の内、日章旗属性のプレーヤーについて、下記のデータをスクレイピングします。<br>
* プレーヤー名
* レイティング
* 勝数、負数、引分数
* Chess.com登録日
* 最後にログインした日

<br>

レイティングと勝敗数の情報は、Blitz, Bullet, Rapid, 960, Daily 960, Daily の６種類のリーダーボード毎に取得します。<br>
尚、日章旗属性というのは、プレーヤー名についている旗が日章旗という意味です。日本に住んでいる外国人の方、海外に住んでいる日本人の方など様々だと思いますが、単に日本が好きなだけで居住地とも実際の国籍ともなんの関係もない方も相当いるのではないかと想像しています。<br>

## 使用方法
**0run_scripts.py** を実行してください。<br>
...._leaderboard_dates.csv というファイルが6つ作成されます。これが欲しかったデータです。
このデータを集計したり加工したりしたものが、.ipynbファイルですが、開いてみていただければ分かると思いますので、この説明は割愛させていただきます。

<br>

## 各コードの簡単な説明
0. 0run_scripts.py<br>
下記1.から4.のコードを順番に実行します。<br>
一つのpyファイルにまとめることも可能でしたが、停電など何らかの理由でスクレイピングの中断を余儀なくされた際に、作業途中からの再開を容易にするためにコードを分けました。csvファイルへの出力が頻繁に行われるのも同様の理由です。<br>
1. 1leaderboard.py<br>
日章旗属性の各リーダーボードから、プレーヤー名、レイティング、勝敗情報を取得します。8時間程度かかると思います。<br>
2. 2unique_player_names.py<br>
各リーダーボードでプレーヤーが当然重複しておりますので、重複のないプレーヤーリストを作成します。すぐ終わります。<br>
3. 3unique_player_dates.py<br>
上記2.で作成したリストのプレーヤーのプロフィールページにアクセスし、chess.comへの登録日と最終ログイン日を取得します。ページからページへの遷移に5秒のスリープを設けていますので、ものすごく時間がかかります。<br>
4. 4merge_on_player_names.py<br>
上記3.で取得した日付のデータをリーダーボードのデータに合体させます。すぐ終わります。<br>

<br>

## 注意点
* スクレイピングの開始から終了まで四日ほどかかります。<br>
ただし、現在ここにあるコードはテスト用にスクレイピングの範囲を各リーダーボードの最初の２ページ（各ボード上位100人）のみに制限しております。この状態であればスクレイピングは１時間ほどで終了しますので、試してみたいという方がいらっしゃいましたら、このままの状態でご試用ください。この制限は、**1leaderboard.py** の117-119秒目をコメントアウトすることで解除できます。<br>

<br>

* Google Chromeがインストール済みであることが必要です<br>
* python 標準ライブラリ以外に使用したのは下記となります。<br>
  * スクレイピング用
    * selenium
    * webdriver_manager
    * pandas
  * 作図用
    * matplotlib
    * matplotlib-venn
    * seaborn

<br>

* Windowsでは動作しません（多分）<br>
これらのコードの作成と実行ははUbuntuベースのDockerコンテナ内で行いました。
私はWindowsでpythonを動かす環境を既に削除しているため確認しておりませんが、**1leaderboard.py** 内の以下のコードを変更すればWindowsで動作すると思います。<br>
  * 23行目 chrome_options .....no-sandbox の行をコメントアウト
  * 30行目 service =...の行をコメントアウト
  * 31行目 driver =...の行をコメントアウト
  * 32行目 # driver =...の行をアンコメント

<br>

* .gitignore に*.csvを含めておりません<br>
成果物がcsvファイルですので、皆様と共有する目的で、敢えて下記のcsvファイルを.gitignoreに含めておりません。その他にも多くのcsvファイルがコードによって生成されますが、それらは.gitignoreに含めております。csvファイルはスクレイピングでコードが使用するものではありませんので、スクレイピングを実行する上では不要です。全て削除していただいて全く問題ありません。<br>
  * blitz_leaderboard_dates.csv
  * bullet_leaderboard_dates.csv
  * rapid_leaderboard_dates.csv
  * 960live_leaderboard_dates.csv
  * 960daily_leaderboard_dates.csv
  * daily_leaderboard_dates.csv

<br>

* 最後にログインした日<br>
ニュージーランド時間から逆算してChess.comサーバーのあるサンフランシスコ時間（タイムゾーン PDT）を計算しています。従って、ニュージーランド以外でこのコードを走らせる場合は、若干の誤差が発生します。3unique_player_dates.pyファイルの76行目でスクレイピングするタイムゾーンを設定しています（ニュージーランドは現在GMT+13時間）。厳密性を求める方はここの数字を変更してください。サンフランシスコも夏時間と冬時間で変わると思いますので、ご確認ください（現在はGMT-7時間）。同じファイルの79行目と92行目です。